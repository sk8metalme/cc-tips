# 開発支援コマンド・プラグイン・エージェント活用ガイド

開発ワークフローを効率化するスラッシュコマンド、キーワードトリガー方式のプラグイン、自動実行エージェントの使い方を解説します。

**参考:** https://github.com/sk8metalme/ai-agent-setup

---

## 概要

ai-agent-setupリポジトリは、計画から実装、PRマージまでの開発フローを自動化するツール群を提供します。

**主要コンポーネント:**
- **スラッシュコマンド** (`/create_pr`, `/git_sync` など) - 明示的に呼び出す定型作業の自動化
- **キーワードトリガー** (deep-dive) - 自然な会話の中で発動する要件明確化ツール
- **エージェント** (code-simplifier, pr-resolver) - `@agent-` 記法で呼び出すコード品質改善・PRレビュー支援ツール

**このガイドで得られること:**
- 定型作業（PR作成、ブランチ同期）の自動化手法
- 要件の曖昧さを早期解消するキーワードトリガー活用法
- コード品質チェックとPRレビュー対応を効率化するエージェント活用法
- TDDベースの開発フロー構築ノウハウ

---

## クイックスタート

### プラグインのインストール

```bash
# マーケットプレイスを追加
/plugin marketplace add sk8metalme/ai-agent-setup
/plugin marketplace add anthropics/claude-plugins-official

# development-toolkit（スラッシュコマンド群 + pr-resolverエージェント）
/plugin install development-toolkit@ai-agent-setup

# deep-dive（キーワードトリガー方式の要件明確化）
/plugin install deep-dive@ai-agent-setup

# code-simplifier（コード品質改善エージェント）
/plugin marketplace update claude-plugins-official
/plugin install code-simplifier
```

### 基本的な使い方

```bash
# === スラッシュコマンド ===
# 1. 計画・設計フェーズ
/plan

# 2. TDD開発フェーズ
/dev

# 3. PR作成
/create_pr

# 4. PRマージ後の同期
/git_sync

# === キーワードトリガー ===
# プロンプトに「深堀り」「ultrathink」などを含める
「ユーザー認証機能を追加したいんだけど、深堀りして設計を固めてほしい」

# === エージェント ===
# @agent-記法でエージェントを呼び出す

# コード品質チェック
@agent-code-simplifier:code-simplifier

# PRレビューコメントのresolve（レビュー対応後）
@agent-pr-resolver:pr-resolver PR #123 のレビューコメントをresolveして
```

---

## コマンドリファレンス

### スラッシュコマンド

#### `/create_pr` - PR作成 + コードレビュー

**目的:** 実装完了後に自動的にPRを作成し、コードレビューを実施します。

**使いどころ:** 実装作業が完了し、PRを作成してレビューを受けたい時

**実行される処理:**
1. 現在のブランチの変更をコミット
2. リモートリポジトリにプッシュ
3. GitHub PR を作成（`gh pr create` を使用）
4. PR の概要やテストプランを自動生成
5. コードレビューチェックリストを提供

**使用例:**

```bash
# 実装完了後に実行
/create_pr
```

**トレードオフ:**
- ✅ **メリット:**
  - PR作成の定型作業を自動化
  - コミットメッセージからPR説明を自動生成
  - レビューチェックリストが自動付与
  - 一貫性のあるPRフォーマット

- ⚠️ **デメリット:**
  - 自動生成されたPR説明が意図と異なる場合がある（レビュー推奨）
  - `gh` コマンドが必要（GitHub CLI）
  - 複雑なPRの場合は手動調整が必要な場合がある

**必要な前提条件:**
- `gh` (GitHub CLI) がインストール済み
- GitHub認証が完了している（`gh auth login`）
- featureブランチで作業している

---

#### `/git_sync` - mainブランチ同期

**目的:** PRマージ後にローカルのmainブランチを最新の状態に同期します。

**使いどころ:** PRがリモートでマージされた後、ローカル環境を最新化したい時

**実行される処理:**
1. 現在のブランチを確認
2. mainブランチに切り替え（または指定されたデフォルトブランチ）
3. `git pull` でリモートの最新状態を取得
4. 不要になったfeatureブランチを削除（オプション）

**使用例:**

```bash
# PRマージ後に実行
/git_sync
```

**トレードオフ:**
- ✅ **メリット:**
  - PRマージ後の同期作業を自動化
  - ブランチの切り替え忘れを防止
  - 不要なfeatureブランチのクリーンアップ

- ⚠️ **デメリット:**
  - ローカルに未コミットの変更がある場合はエラーになる
  - マージされていないPRのブランチを誤って削除する可能性（確認ダイアログあり）

**必要な前提条件:**
- gitリポジトリが初期化されている
- リモートリポジトリ（origin）が設定されている
- PRがリモートでマージ済み

---

### キーワードトリガー

#### deep-dive プラグイン - 要件の深堀り

**目的:** 再帰的な質問によって、ユーザーの曖昧な要件や課題を段階的に明確化し、推測を排除して品質・信頼性を向上させます。

**トリガーキーワード:**
プロンプトに以下のキーワードを含めると自動発動します:
- `深堀り`
- `検討して`
- `ultrathink`
- `よく考えて`
- `他の案は？` / `他にはないか`

**使いどころ:**
- 新機能設計時に要件が曖昧な場合
- 問題解決で根本原因を特定したい時
- 技術調査で選択肢を比較したい時
- 学習や理解を深めたい時
- 仕様を段階的に詳細化する必要がある時

**実行される7段階アプローチ:**
1. **全体理解** - リクエストの背景と文脈を把握
2. **理解状態を表示** - 目的・前提・スコープ・制約・不明点を明示（**毎回必須**）
3. **不明点を特定** - 情報不足と推測箇所を洗い出す
4. **質問実行** - 1～4問の質問で情報収集
5. **理解を更新** - 回答を反映させる
6. **反復** - ステップ2～5を繰り返す
7. **終了提案** - ユーザー承認で完了

**使用例:**

```
# プロンプトにキーワードを含める
「ユーザー認証機能を追加したいんだけど、深堀りして設計を固めてほしい」

# または
「この実装方針でいいか、ultrathink して検討して」

# Claude Codeが以下を自動実行:
# 1. 現在の理解を表示（目的・前提・スコープ・制約・不明点）
# 2. 不明点について1～4問の質問
# 3. 回答を受けて理解を更新
# 4. 再度、現在の理解を表示
# 5. 不明点がなくなるまで反復
```

**トレードオフ:**
- ✅ **メリット:**
  - 要件の曖昧さを早期に解消
  - 認識齟齬を毎回の「理解状態表示」で早期発見
  - 推測を排除し、事実ベースの設計が可能
  - 体系的な7段階プロセスで漏れを防止
  - 自然な会話の中でトリガー可能（スラッシュコマンド不要）

- ⚠️ **デメリット:**
  - 深堀りに時間がかかる場合がある（ただし後戻りのコストは削減）
  - 質問が多すぎて疲弊する可能性（1回1～4問に制限）
  - キーワードを知らないと発動できない

**必要な前提条件:**
- deep-dive プラグインのインストール:
  ```bash
  /plugin marketplace add sk8metalme/ai-agent-setup
  /plugin install deep-dive@ai-agent-setup
  ```

**ベストプラクティス:**

**✅ 推奨事項:**
- **毎回「現在の理解」を確認** - 認識齟齬を早期発見
- 推測を明示し、わからないことは質問する
- 既出内容を再質問しない

**❌ 注意事項:**
- 推測のまま進める
- 1回に5問以上質問する
- 既出内容を再質問する
- 「理解状態の表示」をスキップする

---

### エージェント

#### code-simplifier エージェント - コード品質改善

#### 概要

**目的:** 最近変更されたコードを分析し、明確性・一貫性・保守性を向上させる改善提案を提供します。

**使いどころ:**
- コード作成後の品質チェック
- 冗長性や重複の削減
- ドキュメント・設定ファイルの整理
- コードレビュー前の自動チェック
- リファクタリング候補の発見

#### 使用方法

**実行される処理:**
1. 最近変更されたファイルを分析
2. 冗長な表現や重複コードを検出
3. 一貫性のないフォーマットや命名を特定
4. 構造改善の提案（セクション統合、情報整理など）
5. 優先度付きの改善提案リストを生成

**使用例:**

```bash
# 基本的な使い方（最近変更されたファイルを自動分析）
@agent-code-simplifier:code-simplifier

# 特定のファイルを指定
@agent-code-simplifier:code-simplifier tips/custom-slash-commands.md を分析

# 複数ファイルを指定
@agent-code-simplifier:code-simplifier src/ 配下のすべてのJSファイルを分析
```

#### トレードオフ

**メリット・デメリット:**
- ✅ **メリット:**
  - 人間が見落としがちな冗長性を検出
  - 優先度付きで改善提案（高・中・低）
  - 具体的な修正案を提示
  - コードレビュー前の品質向上
  - ドキュメントやMarkdownファイルにも対応

- ⚠️ **デメリット:**
  - 分析に時間がかかる場合がある（大規模ファイル）
  - 提案が必ずしも最適とは限らない（人間の判断が必要）
  - コンテキストを完全には理解できない場合がある

#### 前提条件

**必要な前提条件:**
- code-simplifier プラグインのインストール:
  ```bash
  /plugin marketplace update claude-plugins-official
  /plugin install code-simplifier
  ```
- 分析対象のファイルが存在すること

#### ベストプラクティス

**✅ 推奨事項:**
- **コミット前に実行** - コード品質を事前チェック
- **優先度「高」から対応** - 重要な改善から実施
- **提案を吟味** - 盲目的に適用せず、コンテキストを考慮
- **ドキュメント整理にも活用** - README、設計書などの品質向上

**❌ 注意事項:**
- 全ての提案を無条件に適用する
- 分析結果を確認せずにコミットする
- 外部ライブラリのコードを改善しようとする
- 意図的な冗長性（説明目的など）を削除する

---

#### pr-resolver エージェント - PRレビューコメント自動resolve

#### 概要

**目的:** PRレビューコメント（スレッド）で対応済みのものを自動的にresolveし、レビュー後の定型作業を効率化します。

**使いどころ:**
- PRレビュー指摘への対応完了後
- コードレビューのフィードバックを反映した後
- CI/CDが通過し、修正が完了した時
- レビュアーとのやり取りが完了した時
- 大量のレビューコメントを一括resolve したい時

#### 使用方法

**実行される処理（8段階プロセス）:**
1. **PR情報取得** - `gh pr view` でPR詳細を確認
2. **未resolveスレッド一覧取得** - GitHub GraphQL APIで対象スレッドを特定
3. **CI/CDステータス確認** - テスト・ビルドの成功を検証
4. **対応判断** - tasks.mdで優先順位を確認し、resolve対象を決定
5. **CI/CD失敗時の原因調査** - ログを確認し、根本原因を理解
6. **ユーザー確認** - 自動resolveする前に必ずユーザーに確認
7. **resolve実行** - `resolveReviewThread` mutation でスレッドをresolve
8. **結果報告** - resolve完了したスレッドの一覧を表示

**使用例:**

```bash
# PR番号を指定して実行
@agent-pr-resolver:pr-resolver PR #123 のレビューコメントをresolveして

# 現在のブランチのPRを自動検出
@agent-pr-resolver:pr-resolver このPRの対応済みコメントをresolveして
```

#### トレードオフ

**メリット・デメリット:**
- ✅ **メリット:**
  - レビュー対応後の定型作業を自動化
  - 大量のコメントを効率的に処理
  - CI/CDステータスを考慮した安全なresolve
  - GraphQL APIで正確なスレッド管理
  - ユーザー確認により誤操作を防止

- ⚠️ **デメリット:**
  - GitHub GraphQL APIの理解が必要
  - 書き込み権限（repo scope）が必要
  - CI/CD失敗時は手動調査が必要
  - 複雑なレビュー状況では判断が難しい場合がある

#### 前提条件

**必要な前提条件:**
- `gh` (GitHub CLI) がインストール済み
- GitHub認証が完了している（`gh auth login`）
- **GitHub PRへの書き込み権限**（repo scope）
- PR番号が明確であること
- CI/CDが設定されている（推奨）

#### ベストプラクティス

**✅ 推奨事項:**
- **推測で判断しない** - CI/CD失敗時は必ずログを確認
- **ユーザー確認必須** - 自動resolveする前に確認を取る
- **事実ベースで処理** - コメントの内容と実際の修正を照合
- **CI/CD通過を確認** - テスト・ビルドが成功していることを検証

**❌ 注意事項:**
- CI/CDログを確認せずにresolveする
- ユーザー確認なしで自動resolve（禁止）
- 未対応のコメントをresolveする
- レビュアーの意図を無視した一括resolve

---

## ワークフロー例

### 基本フロー

標準的な開発フローの例:

```bash
/plan → /dev → @agent-code-simplifier → /create_pr
  ↓ (レビュー受領・修正)
@agent-pr-resolver → /git_sync
```

詳細:
- `/plan`: 要件定義、設計、タスク分割
- `/dev`: TDD開発（Red→Green→Refactor）
- `@agent-code-simplifier`: コード品質チェック・改善提案
- `/create_pr`: PR作成とコードレビューチェックリスト生成
- **(レビュー受領・修正)**: レビュアーからのフィードバックに対応
- `@agent-pr-resolver`: レビューコメントの自動resolve
- `/git_sync`: PRマージ後のローカル環境同期

### レビュー対応フロー（詳細）

PRレビュー後の対応フローの例:

```bash
1. レビューコメントを確認
2. 指摘箇所を修正（/dev で実装）
3. @agent-code-simplifier で品質確認
4. git commit & git push で修正を反映
5. CI/CDの通過を確認
6. @agent-pr-resolver で対応済みコメントをresolve
7. レビュアーに再レビュー依頼
8. 承認後に /git_sync でローカル同期
```

### michiプラグインとの統合

michiプラグインがインストールされている場合は、より包括的なワークフローが利用可能です:

```bash
# michi版の設計フロー（テスト計画含む）
/michi:spec-design

# michi版の実装フロー（5フェーズ品質自動化）
/michi:spec-impl
```

詳細は [推奨プラグイン](recommend-plugin.md) を参照

---

## トラブルシューティング

### `/create_pr` が失敗する

| 問題 | 原因 | 解決策 |
|-----|------|-------|
| `gh` コマンドが見つからない | GitHub CLI未インストール | `brew install gh` でインストール |
| 認証エラー | GitHub認証未完了 | `gh auth login` で認証 |
| PRが重複作成される | 既存のPRがある | `gh pr list` で確認後、既存PRを更新 |

### `/git_sync` が失敗する

| 問題 | 原因 | 解決策 |
|-----|------|-------|
| 未コミットの変更がある | 作業中の変更がある | `git stash` で一時退避 |
| マージコンフリクト | リモートとローカルで差分がある | 手動でコンフリクトを解決 |
| ブランチが見つからない | mainブランチが存在しない | `git branch` でブランチ名を確認 |

### `deep-dive` が発動しない

| 問題 | 原因 | 解決策 |
|-----|------|-------|
| キーワードを含めても発動しない | プラグイン未インストール | `/plugin install deep-dive@ai-agent-setup` |
| 「理解状態」が表示されない | キーワードが不正確 | 正確なキーワード（`深堀り`, `ultrathink`など）を使用 |
| 質問が多すぎる | 初回の情報不足 | できるだけ詳しい背景情報を最初に提供 |

### `code-simplifier` が動作しない

| 問題 | 原因 | 解決策 |
|-----|------|-------|
| エージェントが見つからない | プラグイン未インストール | `/plugin install code-simplifier` でインストール |
| 分析対象が見つからない | 最近の変更がない | 対象ファイルを明示的に指定 |
| 提案が表示されない | 改善点がない、または軽微 | 正常動作。必要に応じて別ファイルを分析 |

### `pr-resolver` が動作しない

| 問題 | 原因 | 解決策 |
|-----|------|-------|
| エージェントが見つからない | プラグイン未インストール | `/plugin install development-toolkit@ai-agent-setup` |
| `gh` コマンドエラー | GitHub CLI未認証 | `gh auth login` で認証し、repo scopeを有効化 |
| 権限エラー | 書き込み権限がない | リポジトリの権限設定を確認、必要に応じて管理者に依頼 |
| resolve対象が見つからない | 既にresolve済み、またはPR番号誤り | `gh pr view` でPR状態を確認 |
| CI/CD失敗でresolve拒否 | テスト・ビルドが失敗している | CI/CDログを確認し、根本原因を解決してから再実行 |

---

## ベストプラクティス

### 1. コミット前の確認

`/create_pr` を実行する前に:
- `git status` で変更内容を確認
- テストが通っていることを確認
- linterの警告を解消
- `@agent-code-simplifier` でコード品質をチェック

### 2. PR説明のレビュー

自動生成されたPR説明は必ず確認し、必要に応じて修正してください。

### 3. ブランチ命名規則

`feature/`, `bugfix/`, `hotfix/` などの接頭辞を使用することで、ワークフローが明確になります。

### 4. 定期的な同期

PRマージ後は必ず `/git_sync` を実行し、ローカル環境を最新に保ちましょう。

---

## 参考リンク

- [ai-agent-setup GitHub](https://github.com/sk8metalme/ai-agent-setup)
- [GitHub CLI (gh) ドキュメント](https://cli.github.com/manual/)
- [Git ブランチ戦略](https://git-scm.com/book/en/v2/Git-Branching-Branching-Workflows)
- [推奨プラグイン Tips](recommend-plugin.md)
- [CLAUDE.md設定 Tips](claude-md-configuration.md)
