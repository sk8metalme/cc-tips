# CLAUDE.md 設定ベストプラクティス

Claude Code の CLAUDE.md 設定をモジュール化し、保守性を高める@インポート方式とディレクトリ構造のベストプラクティス。

## 概要

CLAUDE.md 設定には2つのスコープがあります：

| スコープ | 配置場所 | 適用範囲 | 優先度 |
|---------|---------|---------|--------|
| **グローバル設定** | `~/.claude/CLAUDE.md` | すべてのプロジェクト | 低 |
| **プロジェクト設定** | `プロジェクト/CLAUDE.md` | 特定プロジェクトのみ | 高 |

**優先度階層:**
```
[システムプロンプト]
      ↓ （優先度: 低）
[グローバル設定: ~/.claude/CLAUDE.md]
      ↓ （優先度: 中）
[プロジェクト設定: プロジェクト/CLAUDE.md]
      ↓ （優先度: 高）
```

---

## @インポート方式

CLAUDE.md を複数のモジュールに分割し、`@` 構文でインポートできます。

**構文:**
```markdown
@ディレクトリ/ファイル名.md
```

**使用例（~/.claude/CLAUDE.md）:**
```markdown
# グローバルClaude設定

## 基本設定のインポート

@base/CLAUDE-base.md

## チーム標準のインポート

@team/CLAUDE-team-standards.md

## セキュリティポリシーのインポート

@security/CLAUDE-security-policy.md
```

---

## 推奨ディレクトリ構造

### グローバル設定（~/.claude/）

```
~/.claude/
├── CLAUDE.md                    # エントリーポイント（@インポートのみ）
├── base/
│   └── CLAUDE-base.md           # 基本設定モジュール
├── team/
│   └── CLAUDE-team-standards.md # チーム標準モジュール
└── security/
    └── CLAUDE-security-policy.md # セキュリティポリシーモジュール
```

### プロジェクト設定（プロジェクト/）

```
プロジェクト/
└── CLAUDE.md                    # プロジェクト固有設定
```

---

## 設定分離パターン

各ディレクトリの責務を明確に分離することで、保守性が向上します。

### base/CLAUDE-base.md（基本設定）

**役割:** すべてのプロジェクトで共有される不変の基本ルール

| カテゴリ | 内容例 |
|---------|-------|
| 言語設定 | 日本語応答、質問時のツール使用 |
| AIエージェント動作原則 | ユーザー定義ルールの最優先、通知ルール |
| コーディング原則 | 可読性、保守性、セキュリティ、エラーハンドリング、テスト |
| **開発手法** | **TDD（テスト駆動開発）の推奨** |
| ドキュメント作成 | コメント日本語、API仕様、README管理 |
| 開発ツール | npm, jj, gh, node |

**具体例:**
```markdown
## 基本ルール

- **言語**: 日本語で応答してください
- **プロフェッショナリズム**: 丁寧で専門的な対応を心がけてください
- **コード品質**: クリーンで保守性の高いコードを実装してください

## 共通コーディング原則

1. **可読性**
   - 明確で理解しやすいコードを書く
   - 適切な変数名・関数名を使用

2. **テスト**
   - テスト駆動開発（TDD）を推奨
   - カバレッジ95%以上を目標
```

---

### team/CLAUDE-team-standards.md（チーム標準）

**役割:** チーム固有の開発プロセスとルール

| カテゴリ | 内容例 |
|---------|-------|
| コミュニケーション | 日本語基本、質問推奨 |
| コードレビュー | 必須レビュー、セキュリティ確認 |
| 開発フロー原則 | docs/tmp/管理、TDD基本 |
| ブランチ戦略 | main, develop, feature/, bugfix/, hotfix/ |
| 禁止事項 | main直接push禁止、force push禁止 |
| 品質基準 | カバレッジ95%以上、静的解析 |

**具体例:**
```markdown
## ブランチ戦略

- **main**: 本番環境相当（常にデプロイ可能な状態）
- **develop**: 開発環境（次回リリース予定の機能を統合）
- **feature/**: 機能開発用
- **bugfix/**: バグ修正用（developから分岐）
- **hotfix/**: 緊急修正用（mainから分岐）

## 禁止事項

- main/masterブランチへの直接push/commitは禁止
- force push（`--force`, `-f`）の使用は禁止（特にmain/masterへは厳禁）
```

---

### security/CLAUDE-security-policy.md（セキュリティポリシー）

**役割:** セキュリティ対策とコンプライアンス要件

| カテゴリ | 内容例 |
|---------|-------|
| 必須対策 | 認証・認可、データ保護、入力検証、依存関係管理 |
| 禁止事項 | ハードコーディング禁止、安全でない関数禁止 |
| チェックリスト | セキュアコーディング確認項目 |
| インシデント対応 | 報告フロー |
| Claude Code秘密情報管理 | ~/.secrets/使用、多層防御 |

**具体例:**
```markdown
## 禁止事項

### 絶対に行ってはいけないこと

1. **ハードコーディング禁止**
   - APIキー
   - パスワード
   - 接続文字列
   - 暗号化キー

2. **安全でない関数の使用禁止**
   - eval()や同等の動的コード実行
   - 非推奨のセキュリティ関数
```

---

### プロジェクト/CLAUDE.md（プロジェクト固有設定）

**役割:** プロジェクト固有の設定と優先ルール

| カテゴリ | 内容例 |
|---------|-------|
| プロジェクト概要 | 目的、機能、対象ユーザー |
| リポジトリ構造 | ディレクトリ構成の説明 |
| 開発設定 | outputStyle, 特殊なツール設定 |
| **テスト実行方法** | **テストコマンド、カバレッジ確認方法** |
| **リント方法** | **リンター実行コマンド、設定ファイル** |
| **型チェック・null安全チェック** | **型チェッカー実行方法、strict設定** |
| **アーキテクチャチェック** | **依存関係検証、レイヤー違反検出** |
| **パッケージング方法** | **ビルドコマンド、成果物の配置** |
| **バージョン管理方法** | **タグ付けルール、バージョニング戦略** |
| **CI/CD** | **ワークフロー、デプロイ手順** |
| コンテンツ作成ガイドライン | プロジェクト固有のフォーマット |

**具体例:**
```markdown
# CLAUDE.md

## プロジェクト概要

このプロジェクトは、Eコマースプラットフォームのバックエンド APIです。

## 開発設定

このリポジトリは `outputStyle: "Learning"` で設定されており、
Claude Codeが教育的なインサイトを提供しながら作業を進めます。

## テスト実行方法

**ユニットテスト:**
```bash
npm test                    # すべてのテスト実行
npm run test:coverage       # カバレッジ付きテスト（95%以上必須）
npm run test:watch          # Watch モード
```

**E2Eテスト:**
```bash
npm run test:e2e            # E2Eテスト実行
```

## リント方法

```bash
npm run lint                # ESLint 実行
npm run lint:fix            # 自動修正
```

## 型チェック・null安全チェック

```bash
npm run typecheck           # TypeScript 型チェック
```

**設定:** `tsconfig.json` で `strict: true` を有効化

## アーキテクチャチェック

```bash
npm run arch:check          # レイヤー依存関係の検証
```

**ルール:** controllers → services → repositories の単方向依存のみ許可

## パッケージング方法

```bash
npm run build               # プロダクションビルド
npm run package             # Docker イメージ作成
```

**成果物:** `dist/` ディレクトリに出力

## バージョン管理方法

**セマンティックバージョニング（SemVer）:**
- MAJOR: 破壊的変更
- MINOR: 後方互換性のある機能追加
- PATCH: 後方互換性のあるバグ修正

**タグ付け:**
```bash
git tag -a v1.2.3 -m "Release version 1.2.3"
git push origin v1.2.3
```

## CI/CD

**GitHub Actions ワークフロー:**
- PR作成時: lint + test + typecheck
- main マージ時: build + deploy to staging
- タグpush時: deploy to production

**デプロイ手順:** `.github/workflows/deploy.yml` 参照
```

---

## CLAUDE.mdに記載すべき推奨項目

Claude Codeがプロジェクトを効果的に理解し、適切なコードを生成するために記載すべき項目のチェックリストです。

### グローバル設定（~/.claude/CLAUDE.md）に記載すべき項目

以下は、すべてのプロジェクトで共通する「考え方」や「原則」です：

| 項目 | 説明 | 配置場所 |
|-----|------|---------|
| TDD推奨 | テスト駆動開発の原則 | base/CLAUDE-base.md |
| コード品質基準 | 可読性、保守性、セキュリティの原則 | base/CLAUDE-base.md |
| ドキュメント作成方針 | コメント、API仕様、READMEの管理方針 | base/CLAUDE-base.md |
| ブランチ戦略 | Git フロー、禁止事項 | team/CLAUDE-team-standards.md |
| セキュリティポリシー | 禁止事項、チェックリスト | security/CLAUDE-security-policy.md |

---

### プロジェクト設定（プロジェクト/CLAUDE.md）に記載すべき項目

以下は、プロジェクト固有の「やり方」や「手順」です：

| 項目 | 説明 | 必須度 | 記載例 |
|-----|------|-------|-------|
| テスト実行方法 | テストコマンド、カバレッジ確認方法 | 必須 | `npm test`, `npm run test:coverage` |
| リント方法 | リンター実行コマンド、設定ファイル | 必須 | `npm run lint`, `.eslintrc.json` |
| パッケージング方法 | ビルドコマンド、成果物の配置 | 必須 | `npm run build`, `dist/` ディレクトリ |
| 型チェック | 型チェッカー実行方法、strict設定 | 推奨 | `npm run typecheck`, `strict: true` |
| バージョン管理方法 | タグ付けルール、バージョニング戦略 | 推奨 | SemVer, タグ付け手順 |
| CI/CD | ワークフロー、デプロイ手順 | 推奨 | GitHub Actions, デプロイフロー |
| プロジェクト概要 | 目的、機能、対象ユーザー | 推奨 | プロジェクトの背景と目標 |
| リポジトリ構造 | ディレクトリ構成の説明 | 推奨 | `src/`, `tests/`, `docs/` の役割 |
| アーキテクチャチェック | 依存関係検証、レイヤー違反検出 | オプション | `npm run arch:check`, 依存ルール |

**必須度の定義:**
- **必須**: Claude Codeがコードを生成・修正するために不可欠
- **推奨**: プロジェクトの品質を保つために有用
- **オプション**: あると便利だが、なくても動作する

---

### 記載する際のポイント

1. **具体的なコマンドを記載**
   - ❌ 悪い例: "テストを実行してください"
   - ✅ 良い例: "`npm test` でユニットテスト実行、`npm run test:coverage` でカバレッジ確認（95%以上必須）"

2. **設定ファイルのパスを明記**
   - ❌ 悪い例: "ESLint を使っています"
   - ✅ 良い例: "ESLint: `.eslintrc.json` に設定、`npm run lint` で実行"

3. **基準・ルールを明確化**
   - ❌ 悪い例: "カバレッジを高く保つ"
   - ✅ 良い例: "カバレッジ95%以上を必須とする"

4. **コマンド実行順序を記載**
   - ✅ 良い例: "PR作成前に必ず `npm run lint && npm test && npm run typecheck` を実行"

---

## トレードオフ

### メリット

- ✅ **関心の分離**: 機能ごとにファイルを分割し、変更の影響範囲を限定
- ✅ **再利用性**: 共通設定を複数プロジェクトで共有し、重複を排除
- ✅ **保守性**: 変更箇所を特定しやすく、メンテナンスコストを削減
- ✅ **拡張性**: 新しいモジュールを追加しやすく、設定を段階的に成長させられる
- ✅ **可読性**: ファイルが小さく、各ファイルの責務が明確

### デメリット

- ⚠️ **初期設定の手間**: ディレクトリ構造とファイルを準備する必要がある
- ⚠️ **ファイル間の依存関係管理**: インポート順序や循環参照に注意が必要
- ⚠️ **学習コスト**: @インポート方式の理解とディレクトリ構造の把握が必要
- ⚠️ **オーバーエンジニアリングのリスク**: 小規模プロジェクトでは過剰な分割になる可能性

---

## 実践例

### 最小構成（小規模プロジェクト向け）

**ディレクトリ構造:**
```
~/.claude/
└── CLAUDE.md                    # すべてをまとめたグローバル設定

プロジェクト/
└── CLAUDE.md                    # プロジェクト固有設定（オプション）
```

**適用場面:**
- 個人プロジェクト
- 設定が少なく、分割するメリットが少ない場合

---

### フル構成（中〜大規模プロジェクト向け）

**ディレクトリ構造:**
```
~/.claude/
├── CLAUDE.md                    # エントリーポイント
├── base/
│   └── CLAUDE-base.md           # 基本設定
├── team/
│   └── CLAUDE-team-standards.md # チーム標準
├── security/
│   └── CLAUDE-security-policy.md # セキュリティポリシー
└── custom/
    └── project-templates.md     # カスタムモジュール（オプション）

プロジェクト/
└── CLAUDE.md                    # プロジェクト固有設定
```

**~/.claude/CLAUDE.md の内容:**
```markdown
# グローバルClaude設定

## 基本設定のインポート

@base/CLAUDE-base.md

## チーム標準のインポート

@team/CLAUDE-team-standards.md

## セキュリティポリシーのインポート

@security/CLAUDE-security-policy.md

## カスタムモジュールのインポート（オプション）

@custom/project-templates.md
```

**プロジェクト/CLAUDE.md の内容:**
```markdown
# プロジェクト固有設定

## プロジェクト概要

このプロジェクトは、Eコマースプラットフォームのバックエンド APIです。

## 開発設定

- **outputStyle**: "Learning"
- **テストフレームワーク**: pytest + pytest-cov
- **APIドキュメント**: OpenAPI 3.0

## プロジェクト固有ルール

- すべてのAPIエンドポイントは `/api/v1/` プレフィックスを使用
- 認証は JWT トークンを使用
- レスポンスは JSON:API 仕様に準拠
```

**適用場面:**
- チーム開発
- 複数プロジェクトで共通設定を共有したい場合
- セキュリティポリシーやコーディング規約を厳格に管理したい場合

---

## まとめ

**@インポート方式の利点:**
1. 設定をモジュール化し、関心を分離できる
2. 共通設定を複数プロジェクトで再利用できる
3. 変更の影響範囲が限定され、保守性が向上する

**推奨する使い分け:**
- **小規模プロジェクト**: 単一のCLAUDE.mdファイルで管理
- **中〜大規模プロジェクト**: @インポート方式でモジュール化

**ディレクトリ分離の基本原則:**
- `base/`: 個人に依存しない不変の基本ルール
- `team/`: チームで共有する開発プロセス
- `security/`: セキュリティとコンプライアンス
- `プロジェクト/CLAUDE.md`: プロジェクト固有の設定と優先ルール

---

## 参考リンク

- [Claude Code 公式ドキュメント](https://code.claude.com/docs)
- [Skills 整理方法](skills-organization.md)（設定と成果物の分離パターン）
